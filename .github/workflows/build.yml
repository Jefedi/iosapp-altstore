name: Build and Release JAPP

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  packages: read

jobs:
  build:
    name: Build and Archive
    runs-on: macos-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
      
    - name: Build Archive
      run: |
        set -eo pipefail
        xcodebuild -project JAPP.xcodeproj \
                   -scheme JAPP \
                   -destination generic/platform=iOS \
                   -archivePath $PWD/build/JAPP.xcarchive \
                   archive \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   DEVELOPMENT_TEAM=""
                   
    - name: Create IPA Manually
      run: |
        set -eo pipefail
        
        # CrÃ©er le dossier de payload
        mkdir -p build/Payload
        
        # Copier l'app depuis l'archive
        cp -r build/JAPP.xcarchive/Products/Applications/JAPP.app build/Payload/
        
        # CrÃ©er l'IPA en zippant le dossier Payload
        cd build
        zip -r JAPP.ipa Payload/
        
        # VÃ©rifier que l'IPA a Ã©tÃ© crÃ©Ã©
        ls -la JAPP.ipa
                   
    - name: Create Release Directory
      run: |
        mkdir -p release
        cp build/JAPP.ipa release/JAPP.ipa
        cp INSTALL_GUIDE.md release/
        
        # VÃ©rifier que les fichiers sont dans le dossier release
        ls -la release/
        
    - name: Generate App Info
      run: |
        echo "Build Date: $(date)" > release/build_info.txt
        echo "Commit: ${{ github.sha }}" >> release/build_info.txt
        echo "Branch: ${{ github.ref }}" >> release/build_info.txt
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: JAPP-${{ github.run_number }}
        path: |
          release/
          build/*.xcarchive
          
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: JAPP ${{ github.ref_name }}
        body: |
          ## ðŸ“± JAPP - Compteur Simple
          
          **Installation:**
          1. TÃ©lÃ©chargez le fichier `JAPP.ipa`
          2. Installez avec AltStore, Sideloadly, ou AltServer
          3. Faites confiance au dÃ©veloppeur dans RÃ©glages â†’ GÃ©nÃ©ral â†’ Gestion des appareils
          
          **FonctionnalitÃ©s:**
          - âž• Compteur avec boutons + et -
          - ðŸ”„ Bouton Reset
          - ðŸŽ¨ Interface moderne SwiftUI
          - ðŸŒ™ Support mode sombre/clair
          
          **Configuration:**
          - iOS 17.0+ requis
          - Bundle ID: com.jefedi.japp
          - Version: ${{ github.ref_name }}
        files: |
          release/JAPP.ipa
          release/INSTALL_GUIDE.md
        draft: false
        prerelease: false